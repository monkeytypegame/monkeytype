name: Label PRs "waiting for review/update"

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    types: [review_requested, review_requested]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

jobs:
  manage-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Set up GitHub CLI
        uses: cli/cli@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add 'waiting for review' label if review is requested
        if: github.event_name == 'pull_request' && github.event.action == 'review_requested'
        run: |
          gh pr edit ${{ github.event.pull_request.number }} --add-label "waiting for review"

      - name: Add 'waiting for update' label if changes are requested
        if: github.event_name == 'pull_request_review' && github.event.review.state == 'changes_requested'
        run: |
          gh pr edit ${{ github.event.pull_request.number }} --add-label "waiting for update"

      - name: Remove 'waiting for update' label if a comment is made by the author
        if: github.event_name == 'issue_comment'
        run: |
          comment_author=$(gh pr view ${{ github.event.issue.number }} --json author --jq '.author.login')
          if [ "$comment_author" == "${{ github.actor }}" ]; then
            gh pr edit ${{ github.event.issue.number }} --remove-label "waiting for update"
          fi